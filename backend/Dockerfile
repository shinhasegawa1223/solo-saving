# =============================================================================
# Solo Saving Backend Dockerfile
# =============================================================================
#
# 【なぜこの構成か？】
# Python/FastAPIはコンパイル不要（インタプリタ言語）ですが、
# 依存関係のインストール（pip/uv）には時間がかかります。
# このDockerfileは「ビルドキャッシュ最大化」を目的に設計されています。
#
# 【設計意図】
# 1. 依存関係（pyproject.toml）を先にインストール → キャッシュ可能
# 2. ソースコードは後からコピー → コード変更時も依存関係はスキップ
# 3. 結果: main.pyを1行変えても、ビルドは数秒で完了
#
# =============================================================================

# -----------------------------------------------------------------------------
# ベースイメージ
# -----------------------------------------------------------------------------
# Python 3.12 slim版を使用
# - slim版を選んだ理由: イメージサイズ削減（alpineはmusl libc問題が多い）
# - bookworm (Debian 12): 安定版LTS
FROM python:3.12-slim-bookworm

# uvパッケージマネージャーをコピー
# - uvを選んだ理由: pipより10-100倍高速、依存解決も優秀
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

WORKDIR /app

# -----------------------------------------------------------------------------
# 環境変数設定
# -----------------------------------------------------------------------------
# バイトコードコンパイル有効化 → 起動時間短縮
ENV UV_COMPILE_BYTECODE=1

# キャッシュからコピーモード → Dockerボリュームとの互換性確保
ENV UV_LINK_MODE=copy

# 仮想環境のパス設定
ENV UV_PROJECT_ENVIRONMENT="/opt/venv"
ENV PATH="/opt/venv/bin:$PATH"

# -----------------------------------------------------------------------------
# STEP 1: 依存関係のインストール（キャッシュ対象）
# -----------------------------------------------------------------------------
# 【重要】pyproject.tomlだけを先にコピーしてインストール
# → ソースコード変更時、このレイヤーはキャッシュから再利用される
# → 依存関係の再インストールをスキップできる（ビルド高速化の核心）
COPY pyproject.toml .
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-install-project --no-dev

# -----------------------------------------------------------------------------
# STEP 2: ソースコードのコピー
# -----------------------------------------------------------------------------
# ソースコードはここでコピー（STEP 1の後）
# → main.pyを変更しても、STEP 1はキャッシュヒット
COPY . .

# -----------------------------------------------------------------------------
# STEP 3: プロジェクト本体のインストール
# -----------------------------------------------------------------------------
# プロジェクト自体をインストール（editable installに相当）
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev

# エントリポイントをリセット（uvのデフォルトを無効化）
ENTRYPOINT []

# -----------------------------------------------------------------------------
# 起動コマンド
# -----------------------------------------------------------------------------
# uvicornでFastAPIを起動
# - --reload: 開発時のホットリロード有効（本番では外す）
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
