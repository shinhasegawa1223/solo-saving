# PostgreSQL Row Level Security (RLS) 採用検討結果

## 1. 概要
本プロジェクト（Solo Saving）におけるデータベース設計において、PostgreSQLのRow Level Security（RLS：行単位セキュリティ）の導入を検討しました。
検討の結果、現段階では **採用を見送る（不採用）** ことと決定しました。

## 2. RLSとは
PostgreSQLのRLSは、データベースの行（レコード）ごとにアクセス制御ポリシーを設定できる機能です。
アプリケーションコードではなく、データベース層で「誰がどのデータを参照・変更できるか」を強制することができます。

### メリット
- アプリケーションのバグによるデータ漏洩リスクをDB層で防げる
- マルチテナント型アプリケーション（SaaSなど）で、顧客間のデータ分離を強固にできる

## 3. 採用見送りの理由

### ① シングルユーザー・単一目的のアプリケーションであるため
本アプリケーションは「個人が一人で使用する」ことを前提としています。
- 複数のユーザーが互いのデータを見合う構造ではない
- ユーザー間のデータ分離という要件自体が存在しない（全データが単一ユーザーのもの）
そのため、RLSの最大の強みである「行ごとのアクセス制御」の必要性が極めて低いです。

### ② 開発・運用コストの最適化
RLSを導入する場合、以下のコストが発生します。
- **実装コスト**: 各テーブルへのPolicy定義、DBマイグレーションの複雑化
- **接続管理**: アプリケーションからDB接続時に、現在のユーザーコンテキスト（`SET app.current_user_id = 'xxx'`など）をセットする処理が必要
- **デバッグ**: クエリの結果がユーザーによって変わるため、トラブルシューティングが複雑になる

現在のフェーズでは、機能開発のスピードとシンプルさを優先し、これらのオーバーヘッドを避ける判断をしました。

### ③ アプリケーション層での制御で十分
FastAPI（バックエンド）の依存性注入（Dependency Injection）による認証チェックで、不正なアクセスは十分に防げます。
DB層まで踏み込んだ二重の防御壁は、現状の規模感では過剰設計（Over-engineering）となります。

## 4. 将来の再検討基準
将来的に以下の要件が発生した場合は、RLSの導入を再検討します。

- **マルチユーザー化**: 家族や友人と家計簿を共有する機能などが追加された場合
- **管理画面の導入**: 管理者が特定のユーザーデータのみを閲覧するような要件が出た場合
- **セキュリティ要件の厳格化**: 金融機関レベルの堅牢性が求められるようになった場合

## 5. 結論
**現状はRLSを使用せず、アプリケーションロジックによる認可制御を行う。**
データベース設計はシンプルに保ち、将来的な拡張性を損なわない範囲で開発を進める。
